{% extends 'base.html' %}
{% load static %}

{% block content %}
<main class="lyear-layout-content">
    <div class="container-fluid">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="mdi mdi-heart-pulse"></i> 个人健康状态测评</h4>
            </div>
            <div class="card-body">
                <form id="health-assessment-form" action="{% url 'myneo4j:health-assessment' %}" method="post">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="height"><i class="mdi mdi-human-male-height"></i> 身高 (cm)</label>
                                <input type="number" class="form-control" id="height" name="height" min="100" max="250" required>
                            </div>
                            <div class="form-group">
                                <label for="weight"><i class="mdi mdi-weight-kilogram"></i> 体重 (kg)</label>
                                <input type="number" class="form-control" id="weight" name="weight" min="30" max="200" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="age"><i class="mdi mdi-cake-variant"></i> 年龄</label>
                                <input type="number" class="form-control" id="age" name="age" min="1" max="120" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="blood-pressure"><i class="mdi mdi-heart-pulse"></i> 血压 (mmHg)</label>
                                <input type="text" class="form-control" id="blood-pressure" name="blood-pressure"
                                       placeholder="例如: 120/80" pattern="\d{1,3}/\d{1,3}" required>
                                <small class="form-text text-muted">格式: 收缩压/舒张压</small>
                            </div>
                            <div class="form-group">
                                <label for="blood-sugar"><i class="mdi mdi-blood-bag"></i> 血糖 (mmol/L)</label>
                                <input type="number" class="form-control" id="blood-sugar" name="blood-sugar"
                                       min="2" max="30" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="blood-lipid"><i class="mdi mdi-water"></i> 血脂 (mmol/L)</label>
                                <input type="number" class="form-control" id="blood-lipid" name="blood-lipid"
                                       min="0.1" max="10" step="0.01" required>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sleep-status"><i class="mdi mdi-sleep"></i> 身体最近状况</label>
                                <textarea class="form-control" id="sleep-status" name="sleep-status"
                                          rows="3" placeholder="描述您最近的身体状况和你担心的问题" required></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="sleep-quality"><i class="mdi mdi-moon-waning-crescent"></i> 睡眠质量</label>
                                <select class="form-control" id="sleep-quality" name="sleep-quality" required>
                                    <option value="" disabled selected>请选择</option>
                                    <option value="好">好 - 入睡快，夜间不醒</option>
                                    <option value="一般">一般 - 偶尔失眠</option>
                                    <option value="差">差 - 经常失眠或早醒</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                            <span id="submit-text"><i class="mdi mdi-file-document-edit"></i> 提交测评</span>
                            <span id="loading-spinner" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                    </div>
                </form>

                {% if assessment_result or model_suggestion %}
                <div class="mt-5">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h4 class="mb-0"><i class="mdi mdi-clipboard-text"></i> 测评结果</h4>
                        </div>
                        <div class="card-body">
                            {% if assessment_result %}
                            <div class="alert alert-info">
                                <h5><i class="mdi mdi-chart-line"></i> 健康数据摘要</h5>
                                <pre class="mb-4">{{ assessment_result }}</pre>
                            </div>
                            {% endif %}

                            {% if model_suggestion %}
                            <div class="alert alert-warning">
                                <h5><i class="mdi mdi-robot"></i> AI健康建议</h5>
                                <div style="white-space: pre-line; line-height: 1.6;">{{ model_suggestion }}</div>
                            </div>
                            {% endif %}

                            {% if pdf_url %}
                            <div class="text-center mt-4">
                                <a href="{{ pdf_url }}" class="btn btn-success" download>
                                    <i class="mdi mdi-file-pdf"></i> 下载完整报告 (PDF)
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if error %}
                <div class="alert alert-danger mt-4">
                    <i class="mdi mdi-alert-circle"></i> 错误: {{ error }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</main>

<style>
    .form-control:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    pre {
        white-space: pre-wrap;
        font-family: inherit;
        background: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
    }
</style>

<script>
document.getElementById('health-assessment-form').addEventListener('submit', function(e) {
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    document.getElementById('subminet-text').classList.add('d-none');
    document.getElementById('loading-spinr').classList.remove('d-none');

    // 防止重复提交
    let isSubmitting = false;
    if (isSubmitting) {
        e.preventDefault();
        return;
    }
    isSubmitting = true;
});

// 输入验证
document.getElementById('blood-pressure').addEventListener('input', function(e) {
    if (!/^\d{0,3}\/?\d{0,3}$/.test(e.target.value)) {
        e.target.setCustomValidity('请输入正确的血压格式，如120/80');
    } else {
        e.target.setCustomValidity('');
    }
});
</script>
{% endblock %}
