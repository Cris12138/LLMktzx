{% extends 'base.html' %}
{% load static %}

{% block content %}
<main>
    <div class="container-fluid">
        <div class="card shadow-lg border-0 rounded-lg animate__animated animate__fadeIn main-card">
            <div class="card-header bg-gradient-primary text-white position-relative overflow-hidden enhanced-header">
                <div class="tech-pattern"></div>
                <h4 class="mb-0 d-flex align-items-center position-relative">
                    <i class="mdi mdi-heart-pulse mr-2 pulse-animation"></i>
                    ä¸ªäººå¥åº·çŠ¶æ€æ™ºèƒ½æµ‹è¯„ç³»ç»Ÿ
                    <div class="tech-dots"></div>
                </h4>
            </div>
            <div class="card-body enhanced-body">
                <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
                <div class="assessment-progress mb-4">
                    <div class="progress enhanced-progress" style="height: 8px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-gradient-info enhanced-progress-bar" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>

                <div id="validation-error" class="alert alert-danger d-none shadow-sm animate__animated animate__headShake enhanced-alert">
                    <div class="d-flex align-items-center">
                        <i class="mdi mdi-alert-circle-outline mr-3 error-icon" style="font-size: 1.5rem;"></i>
                        <span>è¯·å¡«å†™æ‰€æœ‰å¿…å¡«çš„å¥åº·æ•°æ®é¡¹ï¼Œç„¶åå†æ¬¡æäº¤ã€‚</span>
                    </div>
                </div>

                <form id="health-assessment-form" method="post" class="needs-validation" novalidate>
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card enhanced-card border-left-primary shadow h-100 py-2 mb-4 hover-card">
                                <div class="card-body">
                                    <h5 class="text-primary mb-3 section-title enhanced-section-title"><i class="mdi mdi-account-details"></i> åŸºç¡€èº«ä½“æ•°æ®</h5>
                                    <div class="form-group">
                                        <label for="height" class="font-weight-bold enhanced-label"><i class="mdi mdi-human-male-height"></i> èº«é«˜ (cm)</label>
                                        <div class="input-group input-group-glow enhanced-input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light enhanced-input-prepend"><i class="mdi mdi-ruler"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg enhanced-input" id="height" name="height" min="100" max="250" placeholder="170" required>
                                            <div class="input-line"></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="weight" class="font-weight-bold enhanced-label"><i class="mdi mdi-weight-kilogram"></i> ä½“é‡ (kg)</label>
                                        <div class="input-group input-group-glow enhanced-input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light enhanced-input-prepend"><i class="mdi mdi-scale-bathroom"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg enhanced-input" id="weight" name="weight" min="30" max="200" step="0.1" placeholder="65.0" required>
                                            <div class="input-line"></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="age" class="font-weight-bold enhanced-label"><i class="mdi mdi-cake-variant"></i> å¹´é¾„</label>
                                        <div class="input-group input-group-glow enhanced-input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light enhanced-input-prepend"><i class="mdi mdi-calendar"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg enhanced-input" id="age" name="age" min="1" max="120" placeholder="35" required>
                                            <div class="input-line"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card enhanced-card border-left-info shadow h-100 py-2 mb-4 hover-card">
                                <div class="card-body">
                                    <h5 class="text-info mb-3 section-title enhanced-section-title"><i class="mdi mdi-clipboard-pulse"></i> ç”Ÿç†å¥åº·æŒ‡æ ‡</h5>
                                    <div class="form-group">
                                        <label for="blood-pressure" class="font-weight-bold enhanced-label"><i class="mdi mdi-heart-pulse"></i> è¡€å‹ (mmHg)</label>
                                        <div class="input-group input-group-glow enhanced-input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light enhanced-input-prepend"><i class="mdi mdi-gauge"></i></span>
                                            </div>
                                            <input type="text" class="form-control form-control-lg enhanced-input" id="blood-pressure" name="blood-pressure"
                                                placeholder="120/80" pattern="\d{1,3}/\d{1,3}" required>
                                            <div class="input-line"></div>
                                        </div>
                                        <small class="form-text text-muted enhanced-help-text">æ ¼å¼: æ”¶ç¼©å‹/èˆ’å¼ å‹</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="blood-sugar" class="font-weight-bold enhanced-label"><i class="mdi mdi-blood-bag"></i> è¡€ç³– (mmol/L)</label>
                                        <div class="input-group input-group-glow enhanced-input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light enhanced-input-prepend"><i class="mdi mdi-chart-line-variant"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg enhanced-input" id="blood-sugar" name="blood-sugar"
                                                min="2" max="30" step="0.1" placeholder="5.4" required>
                                            <div class="input-line"></div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="blood-lipid" class="font-weight-bold enhanced-label"><i class="mdi mdi-water"></i> è¡€è„‚ (mmol/L)</label>
                                        <div class="input-group input-group-glow enhanced-input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light enhanced-input-prepend"><i class="mdi mdi-oil"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg enhanced-input" id="blood-lipid" name="blood-lipid"
                                                min="0.1" max="10" step="0.01" placeholder="4.25" required>
                                            <div class="input-line"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card enhanced-card border-left-warning shadow h-100 py-2 mb-4 hover-card">
                                <div class="card-body">
                                    <h5 class="text-warning mb-3 section-title enhanced-section-title"><i class="mdi mdi-alert-circle-outline"></i> èº«ä½“çŠ¶å†µæè¿°</h5>
                                    <div class="form-group">
                                        <label for="sleep-status" class="font-weight-bold enhanced-label"><i class="mdi mdi-comment-text-outline"></i> èº«ä½“æœ€è¿‘çŠ¶å†µ</label>
                                        <div class="textarea-container enhanced-textarea-container">
                                            <textarea class="form-control form-control-lg enhanced-textarea" id="sleep-status" name="sleep-status"
                                                    rows="4" placeholder="è¯·æè¿°æ‚¨æœ€è¿‘çš„èº«ä½“çŠ¶å†µã€ä¸é€‚ç—‡çŠ¶ä»¥åŠæ‚¨å…³æ³¨çš„å¥åº·é—®é¢˜..." required></textarea>
                                            <div class="textarea-line"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card enhanced-card border-left-success shadow h-100 py-2 mb-4 hover-card">
                                <div class="card-body">
                                    <h5 class="text-success mb-3 section-title enhanced-section-title"><i class="mdi mdi-sleep"></i> ç¡çœ è¯„ä¼°</h5>
                                    <div class="form-group">
                                        <label for="sleep-quality" class="font-weight-bold enhanced-label"><i class="mdi mdi-moon-waning-crescent"></i> ç¡çœ è´¨é‡</label>
                                        <select class="form-control form-control-lg custom-select select-glow enhanced-select" id="sleep-quality" name="sleep-quality" required>
                                            <option value="" disabled selected>ğŸ’¤ è¯·é€‰æ‹©æ‚¨çš„ç¡çœ æƒ…å†µ</option>
                                            <option value="å¥½">ğŸ˜´ ä¼˜è´¨ - å…¥ç¡å¿«ï¼Œå¤œé—´ä¸é†’</option>
                                            <option value="ä¸€èˆ¬">ğŸ˜Œ ä¸€èˆ¬ - å¶å°”å¤±çœ </option>
                                            <option value="å·®">ğŸ˜” è¾ƒå·® - ç»å¸¸å¤±çœ æˆ–æ—©é†’</option>
                                        </select>
                                    </div>
                                    <div class="sleep-animation mt-4 d-flex justify-content-center enhanced-sleep-container">
                                        <div class="sleep-icon-container">
                                            <i class="mdi mdi-weather-night text-primary" style="font-size: 3rem;"></i>
                                            <div class="sleep-stars">
                                                <div class="star star1"></div>
                                                <div class="star star2"></div>
                                                <div class="star star3"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4 mb-3">
                        <!-- æ–°å¢è¯„æµ‹ç±»å‹é€‰æ‹©ä¸‹æ‹‰æ¡† -->
                        <div class="d-flex justify-content-center align-items-center mb-3 enhanced-radio-container">
                            <div class="mr-3">
                                <label for="evaluation-type" class="font-weight-bold enhanced-radio-label"><i class="mdi mdi-speedometer mr-1"></i>è¯„æµ‹ç±»å‹ï¼š</label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline radio-glow enhanced-radio">
                                <input type="radio" id="fast-evaluation" name="evaluation-type" class="custom-control-input" value="fast" checked>
                                <label class="custom-control-label" for="fast-evaluation">æé€Ÿè¯„æµ‹</label>
                            </div>
                            <div class="custom-control custom-radio custom-control-inline radio-glow enhanced-radio">
                                <input type="radio" id="standard-evaluation" name="evaluation-type" class="custom-control-input" value="standard">
                                <label class="custom-control-label" for="standard-evaluation">æ ‡å‡†è¯„æµ‹</label>
                            </div>
                        </div>

                        <button type="button" class="btn btn-primary btn-lg px-5 py-3 shadow-lg hover-scale pulse-btn enhanced-submit-btn" id="submit-btn">
                            <span id="submit-text"><i class="mdi mdi-database-check"></i> æäº¤å¹¶å¼€å§‹æ™ºèƒ½æµ‹è¯„</span>
                            <span id="loading-spinner" class="spinner-border spinner-border-sm ml-2 d-none"></span>
                        </button>
                    </div>
                </form>

                <!-- æµå¼è¾“å‡ºç»“æœåŒºåŸŸ -->
                <div id="assessment-results" class="mt-5 d-none animate__animated animate__fadeIn">
                    <div class="card border-0 shadow-lg result-card enhanced-result-card">
                        <div class="card-header bg-gradient-success text-white position-relative overflow-hidden enhanced-result-header">
                            <div class="tech-pattern-result"></div>
                            <h4 class="mb-0 d-flex align-items-center position-relative">
                                <i class="mdi mdi-clipboard-text mr-2 pulse-animation"></i>
                                å¥åº·æµ‹è¯„ç»“æœæŠ¥å‘Š
                                <div class="tech-dots-result"></div>
                            </h4>
                        </div>
                        <div class="card-body enhanced-result-body">
                            <div class="result-section mb-4 animate__animated animate__fadeInUp enhanced-result-section">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="result-icon bg-info text-white rounded-circle p-2 mr-3 icon-pulse enhanced-result-icon">
                                        <i class="mdi mdi-chart-line" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h5 class="m-0 text-info enhanced-result-title">å¥åº·æ•°æ®åˆ†æ</h5>
                                </div>
                                <div class="result-content bg-light p-4 rounded enhanced-result-content">
                                    <pre class="mb-0">æ‚¨çš„å¥åº·æ•°æ®å·²æäº¤</pre>
                                </div>
                            </div>

                            <div class="result-section animate__animated animate__fadeInUp enhanced-result-section" style="animation-delay: 0.3s">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="result-icon bg-warning text-white rounded-circle p-2 mr-3 icon-pulse enhanced-result-icon">
                                        <i class="mdi mdi-robot-industrial" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h5 class="m-0 text-warning enhanced-result-title">AIæ™ºèƒ½å¥åº·å»ºè®®</h5>
                                </div>
                                <div class="result-content bg-light p-4 rounded enhanced-result-content">
                                    <div id="ai-suggestion-container" class="ai-suggestion enhanced-ai-suggestion">
                                        <div id="ai-suggestion" class="typing-effect">åˆ†æä¸­<span class="typing-dots"></span></div>
                                    </div>
                                </div>
                            </div>

                            <div id="pdf-download-area" class="text-center mt-5 d-none animate__animated animate__fadeInUp" style="animation-delay: 0.6s">
                                <button id="generate-pdf-btn" class="btn btn-info btn-lg mr-2 shadow hover-scale glow-btn enhanced-pdf-btn">
                                    <i class="mdi mdi-file-pdf-box"></i> ç”ŸæˆæŠ¥å‘Š PDF
                                </button>
                                <a id="pdf-download-link" href="#" class="btn btn-success btn-lg shadow hover-scale glow-btn enhanced-download-btn d-none" download>
                                    <i class="mdi mdi-download"></i> ä¸‹è½½å®Œæ•´å¥åº·æŠ¥å‘Š (PDF)
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                {% if error %}
                <div class="alert alert-danger mt-4 shadow-sm animate__animated animate__fadeIn enhanced-alert">
                    <div class="d-flex align-items-center">
                        <i class="mdi mdi-alert-circle-outline mr-3 error-icon" style="font-size: 1.5rem;"></i>
                        <span>é”™è¯¯: {{ error }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</main>

<style>
/* åŸºç¡€æ ·å¼ */
@import url('https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css');

/* ä¸»å¡ç‰‡å¢å¼ºæ ·å¼ */
.main-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(0, 123, 255, 0.1);
    box-shadow: 0 15px 35px rgba(0, 123, 255, 0.1), 0 5px 15px rgba(0, 0, 0, 0.08) !important;
    border-radius: 20px !important;
    overflow: hidden;
    position: relative;
}

.main-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(0, 123, 255, 0.02) 0%, rgba(40, 167, 69, 0.02) 50%, rgba(255, 193, 7, 0.02) 100%);
    pointer-events: none;
    z-index: 0;
}

.enhanced-header {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 50%, #004085 100%) !important;
    border-bottom: 3px solid rgba(255, 255, 255, 0.2);
    position: relative;
    padding: 20px 25px;
}

.enhanced-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
    opacity: 0.3;
    pointer-events: none;
}

.enhanced-body {
    background: transparent;
    padding: 30px;
    position: relative;
    z-index: 1;
}

/* å¢å¼ºçš„è¿›åº¦æ¡ */
.enhanced-progress {
    background: linear-gradient(90deg, #e9ecef 0%, #f8f9fa 100%);
    border-radius: 10px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    position: relative;
}

.enhanced-progress::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.enhanced-progress-bar {
    background: linear-gradient(90deg, #17a2b8 0%, #138496 50%, #117a8b 100%) !important;
    box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
    position: relative;
}

/* å¢å¼ºçš„å¡ç‰‡æ ·å¼ */
.enhanced-card {
    background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 15px !important;
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
}

.enhanced-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background: linear-gradient(90deg, transparent 0%, var(--border-color, #007bff) 50%, transparent 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.enhanced-card.border-left-primary::before {
    --border-color: #007bff;
}

.enhanced-card.border-left-info::before {
    --border-color: #17a2b8;
}

.enhanced-card.border-left-warning::before {
    --border-color: #ffc107;
}

.enhanced-card.border-left-success::before {
    --border-color: #28a745;
}

.enhanced-card:hover::before {
    opacity: 1;
}

.enhanced-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px rgba(0, 123, 255, 0.15), 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    border-color: rgba(0, 123, 255, 0.2);
}

/* å¢å¼ºçš„æ ‡é¢˜æ ·å¼ */
.enhanced-section-title {
    font-weight: 700;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    position: relative;
    display: inline-block;
}

.enhanced-section-title i {
    background: linear-gradient(135deg, currentColor 0%, currentColor 100%);
    -webkit-background-clip: text;
    background-clip: text;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
}

/* å¢å¼ºçš„è¡¨å•æ ‡ç­¾ */
.enhanced-label {
    color: #495057;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    margin-bottom: 8px;
    font-size: 0.95rem;
}

.enhanced-label i {
    color: #6c757d;
    margin-right: 5px;
    filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.1));
}

/* å¢å¼ºçš„è¾“å…¥æ¡†ç»„ */
.enhanced-input-group {
    position: relative;
    border-radius: 10px;
    overflow: hidden;
}

.enhanced-input-prepend .input-group-text {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: 1px solid #dee2e6;
    border-right: none;
    color: #6c757d;
    transition: all 0.3s ease;
}

.enhanced-input {
    border: 1px solid #dee2e6;
    border-left: none;
    border-radius: 0 10px 10px 0;
    background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
    transition: all 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

.enhanced-input:focus {
    background: #ffffff;
    border-color: #80bdff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1), inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

.enhanced-input:focus + .input-line {
    background: linear-gradient(90deg, #007bff 0%, #0056b3 50%, #004085 100%);
}

/* å¢å¼ºçš„æ–‡æœ¬åŸŸ */
.enhanced-textarea-container {
    position: relative;
    border-radius: 10px;
    overflow: hidden;
}

.enhanced-textarea {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
    transition: all 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    resize: vertical;
    min-height: 120px;
}

.enhanced-textarea:focus {
    background: #ffffff;
    border-color: #ffc107;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.1), inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

/* å¢å¼ºçš„é€‰æ‹©æ¡† */
.enhanced-select {
    border: 1px solid #dee2e6;
    border-radius: 10px;
    background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
    transition: all 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    cursor: pointer;
}

.enhanced-select:focus {
    background: #ffffff;
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.1), inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

/* å¢å¼ºçš„ç¡çœ å®¹å™¨ */
.enhanced-sleep-container {
    background: radial-gradient(circle at center, rgba(0, 123, 255, 0.05) 0%, transparent 70%);
    padding: 20px;
    border-radius: 15px;
    position: relative;
}

.enhanced-sleep-container::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(0, 123, 255, 0.1) 0%, transparent 70%);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    animation: pulse-bg 3s ease-in-out infinite;
}

@keyframes pulse-bg {
    0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; }
    50% { transform: translate(-50%, -50%) scale(1.2); opacity: 0.1; }
}

/* å¢å¼ºçš„å•é€‰æŒ‰é’® */
.enhanced-radio-container {
    background: linear-gradient(135deg, rgba(0, 123, 255, 0.05) 0%, rgba(40, 167, 69, 0.05) 100%);
    padding: 15px 25px;
    border-radius: 15px;
    border: 1px solid rgba(0, 123, 255, 0.1);
}

.enhanced-radio-label {
    color: #495057;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.enhanced-radio .custom-control-label {
    color: #6c757d;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
}

.enhanced-radio .custom-control-input:checked ~ .custom-control-label {
    color: #007bff;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 123, 255, 0.3);
}

.enhanced-radio .custom-control-label::before {
    border: 2px solid #dee2e6;
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    transition: all 0.3s ease;
}

.enhanced-radio .custom-control-input:checked ~ .custom-control-label::before {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
}

/* å¢å¼ºçš„æäº¤æŒ‰é’® */
.enhanced-submit-btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 50%, #004085 100%);
    border: none;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3), 0 3px 10px rgba(0, 0, 0, 0.1);
    transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    position: relative;
    overflow: hidden;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.enhanced-submit-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.2) 50%, transparent 100%);
    transition: left 0.6s ease;
}

.enhanced-submit-btn:hover::before {
    left: 100%;
}

.enhanced-submit-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 35px rgba(0, 123, 255, 0.4), 0 5px 15px rgba(0, 0, 0, 0.15);
}

/* å¢å¼ºçš„ç»“æœå¡ç‰‡ */
.enhanced-result-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px !important;
    overflow: hidden;
    position: relative;
}

.enhanced-result-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.02) 0%, rgba(23, 162, 184, 0.02) 50%, rgba(255, 193, 7, 0.02) 100%);
    pointer-events: none;
}

.enhanced-result-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 50%, #17a2b8 100%) !important;
    border-bottom: 3px solid rgba(255, 255, 255, 0.2);
    padding: 20px 25px;
}

.enhanced-result-body {
    padding: 30px;
    position: relative;
    z-index: 1;
}

.enhanced-result-section {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 249, 250, 0.8) 100%);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(0, 0, 0, 0.05);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.enhanced-result-section:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
}

.enhanced-result-icon {
    background: linear-gradient(135deg, var(--icon-color, #17a2b8) 0%, var(--icon-color-dark, #138496) 100%);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    border: 3px solid rgba(255, 255, 255, 0.2);
}

.enhanced-result-icon.bg-info {
    --icon-color: #17a2b8;
    --icon-color-dark: #138496;
}

.enhanced-result-icon.bg-warning {
    --icon-color: #ffc107;
    --icon-color-dark: #e0a800;
}

.enhanced-result-title {
    font-weight: 700;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.enhanced-result-content {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 10px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
}

/* å¢å¼ºçš„AIå»ºè®®å®¹å™¨ */
.enhanced-ai-suggestion {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 1px solid rgba(0, 0, 0, 0.05);
    border-radius: 10px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    position: relative;
}

.enhanced-ai-suggestion::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #ffc107 0%, #fd7e14 50%, #dc3545 100%);
    border-radius: 10px 10px 0 0;
}

/* å¢å¼ºçš„PDFæŒ‰é’® */
.enhanced-pdf-btn {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 50%, #117a8b 100%);
    border: none;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(23, 162, 184, 0.3);
    transition: all 0.3s ease;
    font-weight: 600;
}

.enhanced-pdf-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(23, 162, 184, 0.4);
}

.enhanced-download-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 50%, #17a2b8 100%);
    border: none;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
    transition: all 0.3s ease;
    font-weight: 600;
}

.enhanced-download-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
}

/* å¢å¼ºçš„è­¦å‘Šæ¡† */
.enhanced-alert {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    border: 1px solid #f5c6cb;
    border-radius: 12px;
    border-left: 4px solid #dc3545;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.15);
}

/* å¢å¼ºçš„å¸®åŠ©æ–‡æœ¬ */
.enhanced-help-text {
    color: #6c757d;
    font-size: 0.875rem;
    margin-top: 5px;
    font-style: italic;
}

/* ç§‘æŠ€æ„ŸèƒŒæ™¯å›¾æ¡ˆ */
.tech-pattern {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 25%, transparent 25%,
                transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%,
                transparent 75%, transparent);
    background-size: 20px 20px;
    opacity: 0.3;
    animation: move-bg 15s linear infinite;
}

.tech-pattern-result {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 25%, transparent 25%,
                transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%,
                transparent 75%, transparent);
    background-size: 20px 20px;
    opacity: 0.3;
    animation: move-bg 15s linear infinite;
}

@keyframes move-bg {
    0% { background-position: 0 0; }
    100% { background-position: 40px 40px; }
}

/* ç§‘æŠ€æ„Ÿç‚¹é˜µ */
.tech-dots {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 15px;
    display: flex;
    justify-content: space-between;
}

.tech-dots:before, .tech-dots:after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.7);
    animation: pulse-dots 1.5s infinite alternate;
}

.tech-dots:after {
    animation-delay: 0.5s;
}

.tech-dots-result {
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 15px;
    display: flex;
    justify-content: space-between;
}

.tech-dots-result:before, .tech-dots-result:after {
    content: '';
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: rgba(255,255,255,0.7);
    animation: pulse-dots 1.5s infinite alternate;
}

.tech-dots-result:after {
    animation-delay: 0.5s;
}

@keyframes pulse-dots {
    0% { opacity: 0.4; transform: scale(0.8); }
    100% { opacity: 1; transform: scale(1.2); }
}

/* å¡ç‰‡æ‚¬åœæ•ˆæœ */
.hover-card {
    transition: all 0.3s ease;
    border-left-width: 4px !important;
}

.hover-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.15) !important;
}

/* è¡¨å•è¾“å…¥ç„¦ç‚¹æ•ˆæœ */
.input-group-glow .form-control:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    border-color: #80bdff;
}

.input-line {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #007bff, #00e5ff);
    transition: width 0.3s ease;
}

.form-control:focus + .input-line {
    width: 100%;
}

.textarea-line {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 2px;
    background: linear-gradient(90deg, #ffc107, #ff9800);
    transition: width 0.3s ease;
}

.textarea-container {
    position: relative;
}

.textarea-container textarea:focus + .textarea-line {
    width: 100%;
}

/* ç¡çœ å›¾æ ‡åŠ¨ç”»å¢å¼º */
.sleep-icon-container {
    position: relative;
    display: inline-block;
}

.sleep-stars {
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
}

.star {
    position: absolute;
    background-color: #fff;
    border-radius: 50%;
    opacity: 0;
    animation: twinkle 2s infinite;
}

.star1 {
    width: 4px;
    height: 4px;
    top: 10%;
    left: 20%;
    animation-delay: 0s;
}

.star2 {
    width: 3px;
    height: 3px;
    top: 30%;
    left: 70%;
    animation-delay: 0.5s;
}

.star3 {
    width: 5px;
    height: 5px;
    top: 60%;
    left: 40%;
    animation-delay: 1s;
}

@keyframes twinkle {
    0% { opacity: 0; transform: scale(0.5); }
    50% { opacity: 1; transform: scale(1.2); }
    100% { opacity: 0; transform: scale(0.5); }
}

.sleep-animation {
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
}

/* æŒ‰é’®åŠ¨ç”»æ•ˆæœ */
.hover-scale {
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.hover-scale:hover {
    transform: scale(1.05);
}

.pulse-btn {
    position: relative;
    overflow: hidden;
}

.pulse-btn:after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 5px;
    height: 5px;
    background: rgba(255, 255, 255, 0.5);
    opacity: 0;
    border-radius: 100%;
    transform: scale(1, 1) translate(-50%);
    transform-origin: 50% 50%;
}

.pulse-btn:hover:after {
    animation: ripple 1s ease-out;
}

@keyframes ripple {
    0% {
        transform: scale(0, 0);
        opacity: 0.5;
    }
    100% {
        transform: scale(20, 20);
        opacity: 0;
    }
}

.glow-btn {
    box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    transition: all 0.3s ease;
}

.glow-btn:hover {
    box-shadow: 0 0 15px rgba(0, 123, 255, 0.8);
}

/* å•é€‰æŒ‰é’®æ ·å¼ */
.radio-glow .custom-control-input:checked ~ .custom-control-label::before {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    animation: glow 1.5s infinite alternate;
}

@keyframes glow {
    0% { box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); }
    100% { box-shadow: 0 0 10px rgba(0, 123, 255, 0.8); }
}

/* ä¸‹æ‹‰æ¡†æ ·å¼ */
.select-glow:focus {
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    border-color: #28a745;
}

/* ç»“æœå¡ç‰‡æ ·å¼ */
.result-card {
    transition: all 0.5s ease;
    transform-origin: top center;
}

.icon-pulse {
    animation: icon-pulse 2s infinite;
}

@keyframes icon-pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* é”™è¯¯å›¾æ ‡åŠ¨ç”» */
.error-icon {
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
}

@keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-3px, 0, 0); }
    40%, 60% { transform: translate3d(3px, 0, 0); }
}

/* æ‰“å­—æ•ˆæœåŠ¨ç”» */
.typing-effect {
    position: relative;
}

.typing-dots:after {
    content: '';
    animation: typing-dots 1.5s infinite;
}

@keyframes typing-dots {
    0% { content: '.'; }
    33% { content: '..'; }
    66% { content: '...'; }
    100% { content: ''; }
}

/* ç« èŠ‚æ ‡é¢˜åŠ¨ç”» */
.section-title {
    position: relative;
    display: inline-block;
}

.section-title:after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 0;
    width: 0;
    height: 2px;
    background: currentColor;
    transition: width 0.5s ease;
}

.hover-card:hover .section-title:after {
    width: 100%;
}

/* è„‰å†²åŠ¨ç”» */
.pulse-animation {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 0.7; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
    100% { opacity: 0.7; transform: scale(1); }
}

/* Markdownæ¸²æŸ“æ ·å¼ */
#ai-suggestion {
    line-height: 1.8;
    overflow-y: auto;
    max-height: 500px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    white-space: pre-wrap; /* æ›´æ”¹ä¸ºpre-wrapä»¥ä¿ç•™æ¢è¡Œ */
    transition: all 0.3s ease;
}

/* æ ‡é¢˜æ ·å¼ */
#ai-suggestion h1,
#ai-suggestion h2,
#ai-suggestion h3,
#ai-suggestion h4,
#ai-suggestion h5,
#ai-suggestion h6 {
    margin-top: 1.5em;
    margin-bottom: 0.8em;
    line-height: 1.4;
    color: #333;
    font-weight: 600;
    position: relative;
    padding-left: 10px;
}

#ai-suggestion h1:before,
#ai-suggestion h2:before,
#ai-suggestion h3:before,
#ai-suggestion h4:before,
#ai-suggestion h5:before,
#ai-suggestion h6:before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 4px;
    background: linear-gradient(to bottom, #007bff, #00e5ff);
    border-radius: 2px;
}

#ai-suggestion h1 { font-size: 1.8rem; border-bottom: 2px solid #eaecef; padding-bottom: 0.3rem; }
#ai-suggestion h2 { font-size: 1.6rem; border-bottom: 1px solid #eaecef; padding-bottom: 0.3rem; }
#ai-suggestion h3 { font-size: 1.4rem; }
#ai-suggestion h4 { font-size: 1.2rem; }
#ai-suggestion h5 { font-size: 1.1rem; }
#ai-suggestion h6 { font-size: 1rem; }

/* ç¡®ä¿æ®µè½é—´è· */
#ai-suggestion p {
    margin-bottom: 1em;
    transition: background-color 0.3s ease;
}

#ai-suggestion p:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* å¼ºåˆ¶æ®µè½æ¢è¡Œ */
#ai-suggestion p + p {
    margin-top: 1em;
}

/* åˆ—è¡¨æ ·å¼ */
#ai-suggestion ul, #ai-suggestion ol {
    margin-bottom: 1em;
    padding-left: 2em;
}

#ai-suggestion li {
    margin-bottom: 0.5em;
    position: relative;
    transition: transform 0.2s ease;
}

#ai-suggestion li:hover {
    transform: translateX(5px);
}

#ai-suggestion ul li:before {
    content: 'â€¢';
    color: #007bff;
    font-weight: bold;
    display: inline-block;
    width: 1em;
    margin-left: -1em;
}

/* è¡¨æ ¼æ ·å¼ */
#ai-suggestion table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-radius: 5px;
    overflow: hidden;
}

#ai-suggestion th, #ai-suggestion td {
    border: 1px solid #ddd;
    padding: 0.75rem;
    text-align: left;
    transition: background-color 0.2s ease;
}

#ai-suggestion tr:hover td {
    background-color: rgba(0, 123, 255, 0.05);
}

#ai-suggestion th {
    background: linear-gradient(135deg, #f2f2f2, #e6e6e6);
    color: #333;
    font-weight: 600;
}

/* ä»£ç å—æ ·å¼ */
#ai-suggestion pre {
    background: linear-gradient(135deg, #f0f0f0, #e8e8e8);
    padding: 1rem;
    border-radius: 5px;
    overflow-x: auto;
    margin-bottom: 1em;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    border-left: 3px solid #007bff;
}

#ai-suggestion code {
    font-family: 'Courier New', Courier, monospace;
    background-color: rgba(0,0,0,0.05);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    transition: all 0.2s ease;
}

#ai-suggestion code:hover {
    background-color: rgba(0,0,0,0.1);
}

/* å†…è”ä»£ç æ ·å¼ */
#ai-suggestion p code {
    background-color: rgba(0,0,0,0.05);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', Courier, monospace;
}

/* å¼•ç”¨æ ·å¼ */
#ai-suggestion blockquote {
    padding: 1rem 1.5rem;
    border-left: 4px solid #007bff;
    color: #555;
    margin: 1.5rem 0;
    background: linear-gradient(to right, rgba(0,123,255,0.05), transparent);
    border-radius: 0 5px 5px 0;
    position: relative;
}

#ai-suggestion blockquote:before {
    content: '"';
    font-size: 2rem;
    color: rgba(0,123,255,0.2);
    position: absolute;
    left: 10px;
    top: 0;
}

/* æ°´å¹³çº¿æ ·å¼ */
#ai-suggestion hr {
    height: 3px;
    padding: 0;
    margin: 24px 0;
    background: linear-gradient(to right, #007bff, transparent);
    border: 0;
    border-radius: 3px;
}

/* å¼ºè°ƒæ–‡æœ¬ */
#ai-suggestion strong {
    font-weight: 600;
    color: #0056b3;
}

#ai-suggestion em {
    font-style: italic;
    color: #6610f2;
}

/* æ‰“å­—æ•ˆæœåŠ¨ç”» */
@keyframes typing {
    from { width: 0; }
    to { width: 100%; }
}

@keyframes blink-caret {
    from, to { border-color: transparent; }
    50% { border-color: #333; }
}

.typing-animation {
    overflow: hidden;
    border-right: .15em solid #333; /* å…‰æ ‡æ•ˆæœ */
    white-space: nowrap;
    animation:
        typing 3s steps(40, end),
        blink-caret .75s step-end infinite;
    display: inline-block;
}
</style>

<!-- æ·»åŠ å¿…è¦çš„JavaScriptåº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

<script>
// å…¨å±€å˜é‡å­˜å‚¨å®Œæ•´çš„AIå»ºè®®æ–‡æœ¬
let completeAiSuggestion = '';
let healthData = {};
let isStreamComplete = false;
let streamBuffer = '';
let evaluationType = 'fast'; // é»˜è®¤è¯„æµ‹ç±»å‹ä¸ºæé€Ÿè¯„æµ‹

// é…ç½®markedé€‰é¡¹
marked.setOptions({
    breaks: true,         // å°†å•æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
    gfm: true,            // ä½¿ç”¨GitHubé£æ ¼çš„Markdown
    headerIds: true,      // ä¸ºæ ‡é¢˜ç”ŸæˆID
    mangle: false,        // ä¸è½¬ä¹‰æ ‡é¢˜ä¸­çš„å†…å®¹
    smartLists: true,     // ä½¿ç”¨æ›´æ™ºèƒ½çš„åˆ—è¡¨è¡Œä¸º
    smartypants: true     // ä½¿ç”¨æ›´æ™ºèƒ½çš„æ ‡ç‚¹ç¬¦å·
});

// æ‰“å­—æ•ˆæœæ¸²æŸ“å‡½æ•° - æ›´å¹³æ»‘çš„æ‰“å­—æ•ˆæœ
function renderTypingEffect(element, text, speed = 20) {
    return new Promise((resolve) => {
        element.innerHTML = ''; // æ¸…ç©ºå†…å®¹
        let i = 0;
        let tempContent = '';
        let lastRenderTime = 0;
        const renderInterval = 100; // æ¯100msæ›´æ–°ä¸€æ¬¡DOM

        function typeWriter(timestamp) {
            // æ§åˆ¶æ¸²æŸ“é¢‘ç‡ï¼Œé¿å…é¢‘ç¹DOMæ›´æ–°
            if (!lastRenderTime || timestamp - lastRenderTime >= renderInterval) {
                // ä¸€æ¬¡æ·»åŠ å¤šä¸ªå­—ç¬¦ï¼Œæé«˜æ•ˆç‡
                const charsToAdd = Math.min(5, text.length - i);
                for (let j = 0; j < charsToAdd; j++) {
                    tempContent += text.charAt(i + j);
                }
                i += charsToAdd;

                // ä½¿ç”¨markedè§£æMarkdown
                const htmlContent = marked.parse(tempContent);
                const cleanHtml = DOMPurify.sanitize(htmlContent);

                element.innerHTML = cleanHtml;

                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œå¸¦æœ‰å¹³æ»‘æ•ˆæœ
                const container = element.parentElement;
                container.scrollTo({
                    top: container.scrollHeight,
                    behavior: 'smooth'
                });

                lastRenderTime = timestamp;
            }

            if (i < text.length) {
                requestAnimationFrame(typeWriter);
            } else {
                resolve();
            }
        }

        requestAnimationFrame(typeWriter);
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('health-assessment-form');
    const submitBtn = document.getElementById('submit-btn');
    const validationError = document.getElementById('validation-error');
    const loadingSpinner = document.getElementById('loading-spinner');
    const submitText = document.getElementById('submit-text');
    const assessmentResults = document.getElementById('assessment-results');
    const aiSuggestionElement = document.getElementById('ai-suggestion');
    const aiSuggestionContainer = document.getElementById('ai-suggestion-container');
    const pdfDownloadArea = document.getElementById('pdf-download-area');
    const generatePdfBtn = document.getElementById('generate-pdf-btn');
    const pdfDownloadLink = document.getElementById('pdf-download-link');

    // è·å–è¯„æµ‹ç±»å‹é€‰æ‹©å™¨
    const fastEvaluation = document.getElementById('fast-evaluation');
    const standardEvaluation = document.getElementById('standard-evaluation');

    // æ·»åŠ è¡¨å•è¾“å…¥åŠ¨ç”»æ•ˆæœ
    animateFormFields();

    // ç›‘å¬è¯„æµ‹ç±»å‹å˜åŒ–
    fastEvaluation.addEventListener('change', function() {
        if (this.checked) {
            evaluationType = 'fast';
            anime({
                targets: this.parentElement,
                scale: [1, 1.1, 1],
                duration: 600,
                easing: 'easeOutElastic(1, .8)'
            });
        }
    });

    standardEvaluation.addEventListener('change', function() {
        if (this.checked) {
            evaluationType = 'standard';
            anime({
                targets: this.parentElement,
                scale: [1, 1.1, 1],
                duration: 600,
                easing: 'easeOutElastic(1, .8)'
            });
        }
    });

    // æäº¤è¡¨å•å¤„ç†
    submitBtn.addEventListener('click', function() {
        // è¡¨å•éªŒè¯
        validationError.classList.add('d-none');

        if (form.checkValidity() === false) {
            form.classList.add('was-validated');

            // æ˜¾ç¤ºå…¨å±€é”™è¯¯æç¤º
            validationError.classList.remove('d-none');

            // æ·»åŠ æŠ–åŠ¨åŠ¨ç”»
            anime({
                targets: validationError,
                translateX: [0, -10, 10, -10, 10, 0],
                duration: 600,
                easing: 'easeInOutSine'
            });

            // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªæ— æ•ˆå­—æ®µ
            const firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) {
                firstInvalid.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });
                firstInvalid.focus();

                // æ·»åŠ é«˜äº®åŠ¨ç”»
                anime({
                    targets: firstInvalid,
                    boxShadow: [
                        '0 0 0 rgba(220, 53, 69, 0)',
                        '0 0 10px rgba(220, 53, 69, 0.7)',
                        '0 0 0 rgba(220, 53, 69, 0)'
                    ],
                    duration: 1500,
                    easing: 'easeOutQuad'
                });
            }

            return;
        }

        // é‡ç½®PDFä¸‹è½½åŒºåŸŸ
        pdfDownloadArea.classList.add('d-none');
        pdfDownloadLink.classList.add('d-none');
        generatePdfBtn.classList.remove('d-none');
        generatePdfBtn.disabled = false;
        generatePdfBtn.innerHTML = '<i class="mdi mdi-file-pdf-box"></i> ç”ŸæˆæŠ¥å‘Š PDF';

        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = new FormData(form);
        // å­˜å‚¨å¥åº·æ•°æ®ä¾›åç»­ä½¿ç”¨
        healthData = {
            'height': formData.get('height'),
            'weight': formData.get('weight'),
            'age': formData.get('age'),
            'blood-pressure': formData.get('blood-pressure'),
            'blood-sugar': formData.get('blood-sugar'),
            'blood-lipid': formData.get('blood-lipid'),
            'sleep-status': formData.get('sleep-status'),
            'sleep-quality': formData.get('sleep-quality')
        };

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        submitBtn.disabled = true;
        submitText.classList.add('d-none');
        loadingSpinner.classList.remove('d-none');

        // æ˜¾ç¤ºç»“æœåŒºåŸŸå¹¶æ·»åŠ åŠ¨ç”»
        assessmentResults.classList.remove('d-none');
        anime({
            targets: assessmentResults,
            opacity: [0, 1],
            translateY: [20, 0],
            duration: 800,
            easing: 'easeOutQuad'
        });

        // é‡ç½®AIå»ºè®®å†…å®¹
        aiSuggestionElement.innerHTML = '<div class="typing-effect">åˆ†æä¸­<span class="typing-dots"></span></div>';
        completeAiSuggestion = '';
        streamBuffer = '';
        isStreamComplete = false;

        // è·å–CSRFä»¤ç‰Œ
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // æ„å»ºè¯·æ±‚URL - æ·»åŠ è¯„æµ‹ç±»å‹å‚æ•°
        const url = new URL(window.location.href);
        url.searchParams.set('evaluation_type', evaluationType);
        url.searchParams.set('stream', evaluationType === 'fast' ? 'true' : 'false');

        // å¦‚æœæ˜¯æ ‡å‡†è¯„æµ‹ï¼Œä½¿ç”¨fetch APIè·å–å®Œæ•´å“åº”
        if (evaluationType === 'standard') {
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams(healthData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç½‘ç»œå“åº”å¼‚å¸¸');
                }
                return response.json();
            })
            .then(data => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');

                if (data.model_suggestion) {
                    // ä¿å­˜å®Œæ•´çš„AIå»ºè®®
                    completeAiSuggestion = data.model_suggestion;
                    // ä½¿ç”¨æ‰“å­—æ•ˆæœæ¸²æŸ“Markdownå†…å®¹
                    renderTypingEffect(aiSuggestionElement, data.model_suggestion)
                        .then(() => {
                            // æ˜¾ç¤ºPDFç”ŸæˆæŒ‰é’®å¹¶æ·»åŠ åŠ¨ç”»
                            pdfDownloadArea.classList.remove('d-none');
                            anime({
                                targets: pdfDownloadArea,
                                opacity: [0, 1],
                                translateY: [20, 0],
                                duration: 800,
                                easing: 'easeOutQuad'
                            });

                            // è‡ªåŠ¨ç”ŸæˆPDF
                            generatePDF(healthData, completeAiSuggestion);
                        });
                } else {
                    aiSuggestionElement.innerHTML = '<p class="text-danger">æœªèƒ½è·å–è¯„æµ‹ç»“æœ</p>';
                }
            })
            .catch(error => {
                console.error('æ ‡å‡†è¯„æµ‹è¯·æ±‚é”™è¯¯:', error);
                aiSuggestionElement.innerHTML = `<p class="text-danger">è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                submitBtn.disabled = false;
                submitText.classList.remove('d-none');
                loadingSpinner.classList.add('d-none');
            });
            return;
        }

        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
        xhr.setRequestHeader('Accept', 'text/event-stream');

        // è§£ææµå¼å“åº”
        xhr.onprogress = function() {
            const newData = xhr.responseText.substring(streamBuffer.length);
            streamBuffer = xhr.responseText;
            // è§£æSSEæ ¼å¼æ•°æ®
            const lines = newData.split('\n\n');
            lines.forEach(line => {
                if (line.startsWith('data: ')) {
                    const content = line.substring(6);
                    handleStreamContent(content);
                }
            });
        };

        xhr.onload = function() {
            // æ ‡è®°æµå¼ä¼ è¾“å®Œæˆ
            isStreamComplete = true;
            // æœ€ç»ˆå¤„ç†ä¸€æ¬¡å®Œæ•´å†…å®¹
            finalizeContent();
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            submitBtn.disabled = false;
            submitText.classList.remove('d-none');
            loadingSpinner.classList.add('d-none');

            // æ˜¾ç¤ºPDFç”ŸæˆæŒ‰é’®å¹¶æ·»åŠ åŠ¨ç”»
            pdfDownloadArea.classList.remove('d-none');
            anime({
                targets: pdfDownloadArea,
                opacity: [0, 1],
                translateY: [20, 0],
                duration: 800,
                easing: 'easeOutQuad'
            });

            // è‡ªåŠ¨ç”ŸæˆPDF
            generatePDF(healthData, completeAiSuggestion);
        };

        xhr.onerror = function(error) {
            console.error('Stream error:', error);
            aiSuggestionElement.innerHTML += '<p class="text-danger">è¿æ¥é”™è¯¯ï¼Œè¯·é‡è¯•</p>';
            submitBtn.disabled = false;
            submitText.classList.remove('d-none');
            loadingSpinner.classList.add('d-none');
        };

        // å‘é€è¯·æ±‚
        xhr.send(formData);
    });

    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            if (form.checkValidity()) {
                validationError.classList.add('d-none');
            }
        });
    });

    // å¤„ç†æµå¼å†…å®¹ - ç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹
    function handleStreamContent(content) {
        if (!content) return;

        // æ·»åŠ åˆ°å®Œæ•´å»ºè®®ä¸­
        completeAiSuggestion += content;

        // ç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹ï¼ˆä¸æ¸²æŸ“Markdownï¼‰
        aiSuggestionElement.textContent = completeAiSuggestion;

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        aiSuggestionContainer.scrollTop = aiSuggestionContainer.scrollHeight;
    }

    // æœ€ç»ˆå¤„ç†å†…å®¹ - æ¸²æŸ“Markdown
    function finalizeContent() {
        if (!completeAiSuggestion) return;

        try {
            // é¢„å¤„ç†Markdownå†…å®¹
            const processedMarkdown = preprocessMarkdown(completeAiSuggestion);

            // ä½¿ç”¨markedè§£æMarkdown
            const htmlContent = marked.parse(processedMarkdown);

            // ä½¿ç”¨DOMPurifyæ¸…ç†HTML
            const cleanHtml = DOMPurify.sanitize(htmlContent);

            // æ›´æ–°DOM
            aiSuggestionElement.innerHTML = cleanHtml;

            // æ·»åŠ å†…å®¹å‡ºç°åŠ¨ç”»
            anime({
                targets: '#ai-suggestion h1, #ai-suggestion h2, #ai-suggestion h3, #ai-suggestion p, #ai-suggestion ul, #ai-suggestion ol',
                opacity: [0, 1],
                translateX: [10, 0],
                delay: anime.stagger(100),
                duration: 800,
                easing: 'easeOutQuad'
            });

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            aiSuggestionContainer.scrollTop = aiSuggestionContainer.scrollHeight;
        } catch (error) {
            console.error('Markdownè§£æé”™è¯¯:', error);
            // å¦‚æœè§£æå¤±è´¥ï¼Œä¿æŒåŸå§‹æ–‡æœ¬æ˜¾ç¤º
            aiSuggestionElement.textContent = completeAiSuggestion;
        }
    }

    // Markdowné¢„å¤„ç†å‡½æ•°
    function preprocessMarkdown(markdownText) {
        // 1. ä¿®å¤æ ‡é¢˜æ ¼å¼
        let processed = markdownText.replace(/^(#+)([^\s#])/gm, '$1 $2');
        processed = processed.replace(/(^|\n)(#+)([^\s#])/g, '$1$2 $3');

        // 2. å¤„ç†ç‰¹æ®Šåˆ†éš”ç¬¦
        processed = processed.replace(/###(?!\s*#)/g, '\n\n### ');

        // 3. ç¡®ä¿æ®µè½ä¹‹é—´æœ‰ç©ºè¡Œ
        processed = processed.replace(/([^\n])\n([^\n])/g, '$1\n\n$2');

        // 4. ä¿®å¤åˆ—è¡¨æ ¼å¼
        processed = processed.replace(/^(\s*[\*\-+])\s*([^\s])/gm, '$1 $2');

        return processed;
    }

    // è¡¨å•å­—æ®µåŠ¨ç”»æ•ˆæœ
    function animateFormFields() {
        // è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ
        const formControls = document.querySelectorAll('.form-control');
        formControls.forEach(control => {
            control.addEventListener('focus', function() {
                const card = this.closest('.card');
                if (card) {
                    anime({
                        targets: card,
                        boxShadow: [
                            '0 .5rem 1rem rgba(0,0,0,.15)',
                            '0 .5rem 2rem rgba(0,123,255,.25)',
                            '0 .5rem 1rem rgba(0,0,0,.15)'
                        ],
                        duration: 1000,
                        easing: 'easeOutElastic(1, .8)'
                    });
                }
            });
        });

        // å¡ç‰‡åˆå§‹åŒ–åŠ¨ç”»
        const cards = document.querySelectorAll('.card');
        anime({
            targets: cards,
            opacity: [0, 1],
            translateY: [20, 0],
            delay: anime.stagger(100),
            duration: 800,
            easing: 'easeOutQuad'
        });
    }

    // ç”ŸæˆPDFå‡½æ•°
    function generatePDF(healthData, suggestion) {
        // åˆ›å»ºè¡¨å•æ•°æ®
        const formData = new FormData();
        formData.append('health_data', JSON.stringify(healthData));
        formData.append('model_suggestion', suggestion);

        // æ·»åŠ CSRFä»¤ç‰Œ
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // å‘é€è¯·æ±‚
        fetch('{% url "myneo4j:generate-health-report-pdf" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ›´æ–°ä¸‹è½½é“¾æ¥
                pdfDownloadLink.href = data.pdf_url + '?t=' + new Date().getTime(); // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
                pdfDownloadLink.classList.remove('d-none');
                generatePdfBtn.classList.add('d-none');

                // æ·»åŠ ä¸‹è½½é“¾æ¥çš„åŠ¨ç”»æ•ˆæœ
                anime({
                    targets: pdfDownloadLink,
                    scale: [0.9, 1],
                    opacity: [0, 1],
                    duration: 600,
                    easing: 'easeOutElastic(1, .8)'
                });
            } else {
                alert('ç”Ÿæˆå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                generatePdfBtn.disabled = false;
                generatePdfBtn.innerHTML = '<i class="mdi mdi-file-pdf-box"></i> é‡è¯•ç”ŸæˆæŠ¥å‘Š';
            }
        })
        .catch(error => {
            console.error('PDFç”Ÿæˆé”™è¯¯:', error);
            alert('ç”Ÿæˆå‡ºé”™: ' + error.message);
            generatePdfBtn.disabled = false;
            generatePdfBtn.innerHTML = '<i class="mdi mdi-file-pdf-box"></i> é‡è¯•ç”ŸæˆæŠ¥å‘Š';
        });
    }

    // è¡€å‹è¾“å…¥éªŒè¯
    document.getElementById('blood-pressure').addEventListener('input', function(e) {
        if (!/^\d{0,3}\/?\d{0,3}$/.test(e.target.value)) {
            e.target.setCustomValidity('è¯·è¾“å…¥æ­£ç¡®çš„è¡€å‹æ ¼å¼ï¼Œå¦‚120/80');

            // æ·»åŠ é”™è¯¯æç¤ºåŠ¨ç”»
            anime({
                targets: e.target,
                borderColor: ['#dc3545', '#ced4da'],
                duration: 1000,
                easing: 'easeOutQuad'
            });
        } else {
            e.target.setCustomValidity('');
        }
    });

    // ç¡çœ è´¨é‡é€‰æ‹©æ—¶æ›´æ”¹å›¾æ ‡é¢œè‰²å’ŒåŠ¨ç”»
    document.getElementById('sleep-quality').addEventListener('change', function() {
        const sleepIcon = document.querySelector('.sleep-animation i');
        const sleepStars = document.querySelector('.sleep-stars');

        switch(this.value) {
            case 'å¥½':
                sleepIcon.className = 'mdi mdi-sleep text-success';
                sleepStars.style.display = 'block';
                anime({
                    targets: sleepIcon,
                    rotate: [0, 10, 0],
                    scale: [1, 1.2, 1],
                    duration: 1000,
                    easing: 'easeOutElastic(1, .8)'
                });
                break;
            case 'ä¸€èˆ¬':
                sleepIcon.className = 'mdi mdi-sleep text-warning';
                sleepStars.style.display = 'block';
                anime({
                    targets: sleepIcon,
                    translateX: [0, 5, 0],
                    duration: 800,
                    easing: 'easeOutQuad'
                });
                break;
            case 'å·®':
                sleepIcon.className = 'mdi mdi-sleep-off text-danger';
                sleepStars.style.display = 'none';
                anime({
                    targets: sleepIcon,
                    translateX: [0, -5, 5, -5, 5, 0],
                    duration: 800,
                    easing: 'easeOutQuad'
                });
                break;
            default:
                sleepIcon.className = 'mdi mdi-weather-night text-primary';
                sleepStars.style.display = 'block';
        }
    });

    // åŠ¨æ€èº«é«˜ä½“é‡å…³è”æ•ˆæœ
    document.getElementById('height').addEventListener('input', function() {
        calculateBMI();
    });
    document.getElementById('weight').addEventListener('input', function() {
        calculateBMI();
    });

    function calculateBMI() {
        const height = document.getElementById('height').value;
        const weight = document.getElementById('weight').value;

        if(height && weight) {
            const heightInMeters = height / 100;
            const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);

            // å¯ä»¥ç”¨äºæœªæ¥åŠŸèƒ½æ‰©å±•ï¼Œå¦‚å®æ—¶æ˜¾ç¤ºBMI
            // æ·»åŠ æ•°æ®è¾“å…¥åŠ¨ç”»
            anime({
                targets: '#height, #weight',
                backgroundColor: [
                    'rgba(0, 123, 255, 0.1)',
                    'rgba(255, 255, 255, 1)'
                ],
                duration: 800,
                easing: 'easeOutQuad'
            });
        }
    }

    // ç”ŸæˆPDFæŒ‰é’®äº‹ä»¶
    generatePdfBtn.addEventListener('click', function() {
        // æ£€æŸ¥æ˜¯å¦å®Œæˆ
        if (evaluationType === 'fast' && !isStreamComplete) {
            alert('è¯·ç­‰å¾…è¯„æµ‹å®Œæˆåå†ç”ŸæˆPDF');
            return;
        }

        this.disabled = true;
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> ç”Ÿæˆä¸­...';

        // æ·»åŠ åŠ è½½åŠ¨ç”»
        anime({
            targets: this,
            scale: [1, 0.95, 1],
            duration: 600,
            easing: 'easeOutQuad'
        });

        // ç¡®ä¿ä½¿ç”¨å®Œæ•´çš„AIå»ºè®®å†…å®¹
        const suggestionContent = completeAiSuggestion || aiSuggestionElement.textContent;

        if (!suggestionContent || suggestionContent.trim() === 'åˆ†æä¸­...') {
            alert('AIåˆ†æå†…å®¹å°šæœªå‡†å¤‡å¥½');
            this.disabled = false;
            this.innerHTML = '<i class="mdi mdi-file-pdf-box"></i> ç”ŸæˆæŠ¥å‘Š PDF';
            return;
        }

        // è°ƒç”¨PDFç”Ÿæˆå‡½æ•°
        generatePDF(healthData, suggestionContent);
    });
});
</script>
{% endblock %}