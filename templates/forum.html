{% extends 'base.html' %}
{% load static %}
{% block content %}
    <main class="lyear-layout-content">
        <div class="container-fluid">
            <!-- 论坛头部 -->
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-comments"></i> 医疗论坛</h4>
            </div>
            <div class="container-fluid mt-3">
                <form method="get" action="{% url 'myneo4j:forum' %}" class="mb-4">
                    <div class="input-group shadow-lg rounded-pill">
                        <input type="text"
                               name="q"
                               class="form-control border-0 rounded-start-pill"
                               placeholder="输入关键词搜索帖子..."
                               value="{{ search_query }}">
                        <button type="submit" class="btn btn-primary rounded-end-pill px-4">
                            <i class="fas fa-search me-2"></i> 搜索  <!-- 添加文字 -->
                        </button>
                    </div>
                </form>

                <!-- 搜索结果提示 -->
                {% if search_query %}
                <div class="alert alert-info alert-dismissible fade show">
                    找到 <strong>{{ posts.paginator.count }}</strong> 条关于 "{{ search_query }}" 的结果
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endif %}
            </div>
            <!-- 帖子列表（更大的可滚动区域） -->
            <div class="row mt-4" style="height: calc(100vh - 200px); overflow-y: auto; margin-bottom: 10px;">
                <div class="col-md-12">
                    <div class="card shadow-sm">
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for post in posts %}
                                <div class="list-group-item list-group-item-action">
                                    <a href="{% url 'myneo4j:post_detail' post.id %}" class="text-decoration-none text-dark">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h5 class="mb-1">{{ post.title }}</h5>
                                            <small class="text-muted">{{ post.created_at|timesince }}前</small>
                                        </div>
                                        <p class="mb-1">{{ post.content|truncatechars:100 }}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">作者: {{ post.author.username }}</small>
                                            <div>
                                                <span class="badge bg-light text-dark me-2">
                                                    <i class="fas fa-thumbs-up text-primary"></i>
                                                    <span class="like-count">{{ post.likes_count }} 点赞</span>
                                                </span>
                                                <small><i class="fas fa-comment me-1"></i> {{ post.replies.count }} 回复</small>
                                            </div>
                                        </div>
                                    </a>
                                </div>
                                {% empty %}
                                <div class="list-group-item">
                                    <p class="text-muted">暂无帖子</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 修改分页链接保持搜索参数 -->
            <div class="row mt-3">
                <div class="col-md-12">
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if posts.has_previous %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?page={{ posts.previous_page_number }}&q={{ search_query|urlencode }}">
                                    上一页
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link">上一页</a>
                            </li>
                            {% endif %}

                            {% for num in posts.paginator.page_range %}
                            <li class="page-item {% if num == posts.number %}active{% endif %}">
                                <a class="page-link"
                                   href="?page={{ num }}&q={{ search_query|urlencode }}">
                                    {{ num }}
                                </a>
                            </li>
                            {% endfor %}

                            {% if posts.has_next %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?page={{ posts.next_page_number }}&q={{ search_query|urlencode }}">
                                    下一页
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link">下一页</a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>

            <!-- 固定底部的快速发帖区域（更小的框架） -->
            <div class="fixed-bottom bg-white p-2 border-top" style="box-shadow: 0 -2px 10px rgba(0,0,0,0.1); height: 150px;">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <form action="{% url 'myneo4j:create_post' %}" method="post" class="mb-0">
                                {% csrf_token %}
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-4">
                                        <div class="form-floating">
                                            <input type="text" class="form-control form-control-sm" id="postTitle" placeholder="帖子标题" name="title" required>
                                            <label for="postTitle">帖子标题</label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-floating">
                                            <textarea class="form-control form-control-sm" placeholder="写下您的内容" name="content" style="height: 60px" required></textarea>
                                            <label>内容</label>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary btn-sm w-100 h-100">
                                            <i class="fas fa-paper-plane me-1"></i> 发布
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* 论坛专用样式 */
            .list-group-item {
                border-left: none;
                border-right: none;
                transition: all 0.3s;
            }
            .list-group-item:hover {
                background-color: #f8f9fa;
            }
            .list-group-item h5 {
                color: #007bff;
            }
            .card-header {
                border-radius: 0.25rem 0.25rem 0 0 !important;
            }
            .badge {
                padding: 0.35em 0.65em;
            }
            /* 搜索框样式 */
            .search-box {
                transition: all 0.3s ease;
            }
            .search-box:focus {
                box-shadow: 0 0 15px rgba(13, 110, 253, 0.25);
            }

            /* 高亮搜索结果 */
            .highlight {
                background-color: #fff3cd;
                padding: 2px 4px;
                border-radius: 3px;
            }
            /* 防止底部固定区域遮挡内容 */
            body {
                padding-bottom: 160px;
            }

            /* 响应式调整 */
            @media (max-width: 768px) {
                .fixed-bottom {
                    height: 180px !important;
                    padding: 5px !important;
                }
                body {
                    padding-bottom: 190px;
                }
                .lyear-layout-content {
                    padding-bottom: 10px !important;
                }
                .form-control-sm {
                    font-size: 0.875rem;
                }
            }
        </style>
    </main>
{% endblock %}