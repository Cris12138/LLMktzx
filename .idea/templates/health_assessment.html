{% extends 'base.html' %}
{% load static %}

{% block content %}
<main class="lyear-layout-content">
    <div class="container-fluid">
        <div class="card shadow-lg border-0 rounded-lg">
            <div class="card-header bg-gradient-primary text-white">
                <h4 class="mb-0 d-flex align-items-center">
                    <i class="mdi mdi-heart-pulse mr-2 pulse-animation"></i>
                    个人健康状态智能测评系统
                </h4>
            </div>
            <div class="card-body">
                <!-- 进度指示器 -->
                <div class="assessment-progress mb-4">
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>

                <form id="health-assessment-form" method="post" class="needs-validation" novalidate>
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-left-primary shadow h-100 py-2 mb-4">
                                <div class="card-body">
                                    <h5 class="text-primary mb-3"><i class="mdi mdi-account-details"></i> 基础身体数据</h5>
                                    <div class="form-group">
                                        <label for="height" class="font-weight-bold"><i class="mdi mdi-human-male-height"></i> 身高 (cm)</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light"><i class="mdi mdi-ruler"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg" id="height" name="height" min="100" max="250" placeholder="170" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="weight" class="font-weight-bold"><i class="mdi mdi-weight-kilogram"></i> 体重 (kg)</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light"><i class="mdi mdi-scale-bathroom"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg" id="weight" name="weight" min="30" max="200" step="0.1" placeholder="65.0" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="age" class="font-weight-bold"><i class="mdi mdi-cake-variant"></i> 年龄</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light"><i class="mdi mdi-calendar"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg" id="age" name="age" min="1" max="120" placeholder="35" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card border-left-info shadow h-100 py-2 mb-4">
                                <div class="card-body">
                                    <h5 class="text-info mb-3"><i class="mdi mdi-clipboard-pulse"></i> 生理健康指标</h5>
                                    <div class="form-group">
                                        <label for="blood-pressure" class="font-weight-bold"><i class="mdi mdi-heart-pulse"></i> 血压 (mmHg)</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light"><i class="mdi mdi-gauge"></i></span>
                                            </div>
                                            <input type="text" class="form-control form-control-lg" id="blood-pressure" name="blood-pressure"
                                                placeholder="120/80" pattern="\d{1,3}/\d{1,3}" required>
                                        </div>
                                        <small class="form-text text-muted">格式: 收缩压/舒张压</small>
                                    </div>
                                    <div class="form-group">
                                        <label for="blood-sugar" class="font-weight-bold"><i class="mdi mdi-blood-bag"></i> 血糖 (mmol/L)</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light"><i class="mdi mdi-chart-line-variant"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg" id="blood-sugar" name="blood-sugar"
                                                min="2" max="30" step="0.1" placeholder="5.4" required>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="blood-lipid" class="font-weight-bold"><i class="mdi mdi-water"></i> 血脂 (mmol/L)</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light"><i class="mdi mdi-oil"></i></span>
                                            </div>
                                            <input type="number" class="form-control form-control-lg" id="blood-lipid" name="blood-lipid"
                                                min="0.1" max="10" step="0.01" placeholder="4.25" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-left-warning shadow h-100 py-2 mb-4">
                                <div class="card-body">
                                    <h5 class="text-warning mb-3"><i class="mdi mdi-alert-circle-outline"></i> 身体状况描述</h5>
                                    <div class="form-group">
                                        <label for="sleep-status" class="font-weight-bold"><i class="mdi mdi-comment-text-outline"></i> 身体最近状况</label>
                                        <textarea class="form-control form-control-lg" id="sleep-status" name="sleep-status"
                                                rows="4" placeholder="请描述您最近的身体状况、不适症状以及您关注的健康问题..." required></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-left-success shadow h-100 py-2 mb-4">
                                <div class="card-body">
                                    <h5 class="text-success mb-3"><i class="mdi mdi-sleep"></i> 睡眠评估</h5>
                                    <div class="form-group">
                                        <label for="sleep-quality" class="font-weight-bold"><i class="mdi mdi-moon-waning-crescent"></i> 睡眠质量</label>
                                        <select class="form-control form-control-lg custom-select" id="sleep-quality" name="sleep-quality" required>
                                            <option value="" disabled selected>请选择您的睡眠情况</option>
                                            <option value="好">优质 - 入睡快，夜间不醒</option>
                                            <option value="一般">一般 - 偶尔失眠</option>
                                            <option value="差">较差 - 经常失眠或早醒</option>
                                        </select>
                                    </div>
                                    <div class="sleep-animation mt-4 d-flex justify-content-center">
                                        <i class="mdi mdi-weather-night text-primary" style="font-size: 3rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4 mb-3">
                        <button type="button" class="btn btn-primary btn-lg px-5 py-3 shadow-lg hover-scale" id="submit-btn">
                            <span id="submit-text"><i class="mdi mdi-database-check"></i> 提交并开始智能测评</span>
                            <span id="loading-spinner" class="spinner-border spinner-border-sm ml-2 d-none"></span>
                        </button>
                    </div>
                </form>

                <!-- 流式输出结果区域 -->
                <div id="assessment-results" class="mt-5 d-none">
                    <div class="card border-0 shadow-lg">
                        <div class="card-header bg-gradient-success text-white">
                            <h4 class="mb-0 d-flex align-items-center">
                                <i class="mdi mdi-clipboard-text mr-2 pulse-animation"></i>
                                健康测评结果报告
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="result-section mb-4">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="result-icon bg-info text-white rounded-circle p-2 mr-3">
                                        <i class="mdi mdi-chart-line" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h5 class="m-0 text-info">健康数据分析</h5>
                                </div>
                                <div class="result-content bg-light p-4 rounded">
                                    <pre class="mb-0">您的健康评估已完成</pre>
                                </div>
                            </div>

                            <div class="result-section">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="result-icon bg-warning text-white rounded-circle p-2 mr-3">
                                        <i class="mdi mdi-robot-industrial" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h5 class="m-0 text-warning">AI智能健康建议</h5>
                                </div>
                                <div class="result-content bg-light p-4 rounded">
                                    <div id="ai-suggestion-container" class="ai-suggestion">
                                        <div id="ai-suggestion">分析中...</div>
                                    </div>
                                </div>
                            </div>

                            <div id="pdf-download-area" class="text-center mt-5 d-none">
                                <button id="generate-pdf-btn" class="btn btn-info btn-lg mr-2 shadow hover-scale">
                                    <i class="mdi mdi-file-pdf-box"></i> 生成报告 PDF
                                </button>
                                <a id="pdf-download-link" href="#" class="btn btn-success btn-lg shadow hover-scale d-none" download>
                                    <i class="mdi mdi-download"></i> 下载完整健康报告 (PDF)
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                {% if error %}
                <div class="alert alert-danger mt-4 shadow-sm">
                    <div class="d-flex align-items-center">
                        <i class="mdi mdi-alert-circle-outline mr-3" style="font-size: 1.5rem;"></i>
                        <span>错误: {{ error }}</span>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</main>

<style>
/* 基础样式 */
.hover-scale {
    transition: transform 0.2s;
}
.hover-scale:hover {
    transform: scale(1.05);
}
.pulse-animation {
    animation: pulse 2s infinite;
}
@keyframes pulse {
    0% { opacity: 0.7; }
    50% { opacity: 1; }
    100% { opacity: 0.7; }
}
.sleep-animation {
    animation: float 3s ease-in-out infinite;
}
@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
}

/* Markdown渲染样式 */
/* Markdown渲染样式 */
#ai-suggestion {
    line-height: 1.8;
    overflow-y: auto;
    max-height: 500px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    white-space: pre-wrap; /* 更改为pre-wrap以保留换行 */
}

/* 标题样式 */
#ai-suggestion h1,
#ai-suggestion h2,
#ai-suggestion h3,
#ai-suggestion h4,
#ai-suggestion h5,
#ai-suggestion h6 {
    margin-top: 1.5em;
    margin-bottom: 0.8em;
    line-height: 1.4;
    color: #333;
    font-weight: 600;
}

#ai-suggestion h1 { font-size: 1.8rem; border-bottom: 2px solid #eaecef; padding-bottom: 0.3rem; }
#ai-suggestion h2 { font-size: 1.6rem; border-bottom: 1px solid #eaecef; padding-bottom: 0.3rem; }
#ai-suggestion h3 { font-size: 1.4rem; }
#ai-suggestion h4 { font-size: 1.2rem; }
#ai-suggestion h5 { font-size: 1.1rem; }
#ai-suggestion h6 { font-size: 1rem; }

/* 确保段落间距 */
#ai-suggestion p {
    margin-bottom: 1em;
}

/* 强制段落换行 */
#ai-suggestion p + p {
    margin-top: 1em;
}


/* 列表样式 */
#ai-suggestion ul, #ai-suggestion ol {
    margin-bottom: 1em;
    padding-left: 2em;
}

#ai-suggestion li {
    margin-bottom: 0.5em;
}

/* 表格样式 */
#ai-suggestion table {
    border-collapse: collapse;
    width: 100%;
    margin-bottom: 1rem;
}

#ai-suggestion th, #ai-suggestion td {
    border: 1px solid #ddd;
    padding: 0.5rem;
    text-align: left;
}

#ai-suggestion th {
    background-color: #f2f2f2;
}

/* 代码块样式 */
#ai-suggestion pre {
    background-color: #f0f0f0;
    padding: 0.8rem;
    border-radius: 4px;
    overflow-x: auto;
    margin-bottom: 1em;
}

#ai-suggestion code {
    font-family: monospace;
    background-color: #f0f0f0;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
}

/* 内联代码样式 */
#ai-suggestion p code {
    background-color: #f0f0f0;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: monospace;
}

/* 引用样式 */
#ai-suggestion blockquote {
    padding-left: 1rem;
    border-left: 4px solid #ccc;
    color: #666;
    margin: 1rem 0;
}

/* 水平线样式 */
#ai-suggestion hr {
    height: 0.25em;
    padding: 0;
    margin: 24px 0;
    background-color: #e1e4e8;
    border: 0;
}

/* 强调文本 */
#ai-suggestion strong {
    font-weight: 600;
}

#ai-suggestion em {
    font-style: italic;
}
</style>

<!-- 添加必要的JavaScript库 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>

<script>
// 全局变量存储完整的AI建议文本
// 全局变量存储未处理的内容和完整建议
// 全局变量存储完整的AI建议文本和状态
let completeAiSuggestion = '';
let healthData = {};
let isStreamComplete = false;
let streamBuffer = '';

// 配置marked选项
marked.setOptions({
    breaks: true,         // 将单换行符转换为<br>
    gfm: true,            // 使用GitHub风格的Markdown
    headerIds: true,      // 为标题生成ID
    mangle: false,        // 不转义标题中的内容
    smartLists: true,     // 使用更智能的列表行为
    smartypants: true     // 使用更智能的标点符号
});

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('health-assessment-form');
    const submitBtn = document.getElementById('submit-btn');
    const loadingSpinner = document.getElementById('loading-spinner');
    const submitText = document.getElementById('submit-text');
    const assessmentResults = document.getElementById('assessment-results');
    const aiSuggestionElement = document.getElementById('ai-suggestion');
    const aiSuggestionContainer = document.getElementById('ai-suggestion-container');
    const pdfDownloadArea = document.getElementById('pdf-download-area');
    const generatePdfBtn = document.getElementById('generate-pdf-btn');
    const pdfDownloadLink = document.getElementById('pdf-download-link');

    // 提交表单处理
    submitBtn.addEventListener('click', function() {
        // 表单验证
        if (form.checkValidity() === false) {
            form.classList.add('was-validated');
            return;
        }

        // 收集表单数据
        const formData = new FormData(form);

        // 存储健康数据供后续使用
        healthData = {
            'height': formData.get('height'),
            'weight': formData.get('weight'),
            'age': formData.get('age'),
            'blood-pressure': formData.get('blood-pressure'),
            'blood-sugar': formData.get('blood-sugar'),
            'blood-lipid': formData.get('blood-lipid'),
            'sleep-status': formData.get('sleep-status'),
            'sleep-quality': formData.get('sleep-quality')
        };

        // 显示加载状态
        submitBtn.disabled = true;
        submitText.classList.add('d-none');
        loadingSpinner.classList.remove('d-none');

        // 显示结果区域
        assessmentResults.classList.remove('d-none');

        // 重置AI建议内容
        aiSuggestionElement.innerHTML = '';
        completeAiSuggestion = '';
        streamBuffer = '';
        isStreamComplete = false;

        // 获取CSRF令牌
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // 构建请求URL
        const url = new URL(window.location.href);
        url.searchParams.set('stream', 'true');

        // 创建请求对象
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
        xhr.setRequestHeader('X-CSRFToken', csrfToken);
        xhr.setRequestHeader('Accept', 'text/event-stream');

        // 解析流式响应
        xhr.onprogress = function() {
            const newData = xhr.responseText.substring(streamBuffer.length);
            streamBuffer = xhr.responseText;

            // 解析SSE格式数据
            const lines = newData.split('\n\n');
            lines.forEach(line => {
                if (line.startsWith('data: ')) {
                    const content = line.substring(6);
                    handleStreamContent(content);
                }
            });
        };

        xhr.onload = function() {
            // 标记流式传输完成
            isStreamComplete = true;

            // 最终处理一次完整内容
            finalizeContent();

            // 恢复按钮状态
            submitBtn.disabled = false;
            submitText.classList.remove('d-none');
            loadingSpinner.classList.add('d-none');

            // 显示PDF生成按钮
            pdfDownloadArea.classList.remove('d-none');
        };

        xhr.onerror = function(error) {
            console.error('Stream error:', error);
            aiSuggestionElement.innerHTML += '<p class="text-danger">连接错误，请重试</p>';
            submitBtn.disabled = false;
            submitText.classList.remove('d-none');
            loadingSpinner.classList.add('d-none');
        };

        // 发送请求
        xhr.send(formData);
    });

    // 处理流式内容 - 直接显示原始内容
    function handleStreamContent(content) {
        if (!content) return;

        // 添加到完整建议中
        completeAiSuggestion += content;

        // 直接显示原始内容（不渲染Markdown）
        aiSuggestionElement.textContent = completeAiSuggestion;

        // 自动滚动到底部
        aiSuggestionContainer.scrollTop = aiSuggestionContainer.scrollHeight;
    }

    // 最终处理内容 - 渲染Markdown
    function finalizeContent() {
        if (!completeAiSuggestion) return;

        try {
            // 预处理Markdown内容
            const processedMarkdown = preprocessMarkdown(completeAiSuggestion);

            // 使用marked解析Markdown
            const htmlContent = marked.parse(processedMarkdown);

            // 使用DOMPurify清理HTML
            const cleanHtml = DOMPurify.sanitize(htmlContent);

            // 更新DOM
            aiSuggestionElement.innerHTML = cleanHtml;

            // 自动滚动到底部
            aiSuggestionContainer.scrollTop = aiSuggestionContainer.scrollHeight;
        } catch (error) {
            console.error('Markdown解析错误:', error);
            // 如果解析失败，保持原始文本显示
            aiSuggestionElement.textContent = completeAiSuggestion;
        }
    }

    // Markdown预处理函数
    function preprocessMarkdown(markdownText) {
        // 1. 修复标题格式
        let processed = markdownText.replace(/^(#+)([^\s#])/gm, '$1 $2');
        processed = processed.replace(/(^|\n)(#+)([^\s#])/g, '$1$2 $3');

        // 2. 处理特殊分隔符
        processed = processed.replace(/###(?!\s*#)/g, '\n\n### ');

        // 3. 确保段落之间有空行
        processed = processed.replace(/([^\n])\n([^\n])/g, '$1\n\n$2');

        // 4. 修复列表格式
        processed = processed.replace(/^(\s*[\*\-+])\s*([^\s])/gm, '$1 $2');

        return processed;
    }

    // PDF生成按钮处理
    generatePdfBtn.addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="mdi mdi-loading mdi-spin"></i> 生成中...';

        // 创建一个表单提交
        const formData = new FormData();
        formData.append('health_data', JSON.stringify(healthData));
        formData.append('model_suggestion', completeAiSuggestion);

        // 发送请求生成PDF
        fetch('{% url "myneo4j:generate-health-report-pdf" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 更新下载链接
                pdfDownloadLink.href = data.pdf_url;
                pdfDownloadLink.classList.remove('d-none');
                generatePdfBtn.classList.add('d-none');
            } else {
                alert('PDF生成失败: ' + data.error);
                generatePdfBtn.disabled = false;
                generatePdfBtn.innerHTML = '<i class="mdi mdi-file-pdf-box"></i> 重试生成报告';
            }
        })
        .catch(error => {
            console.error('PDF生成错误:', error);
            alert('PDF生成出错，请重试');
            generatePdfBtn.disabled = false;
            generatePdfBtn.innerHTML = '<i class="mdi mdi-file-pdf-box"></i> 重试生成报告';
        });
    });

    // 血压输入验证
    document.getElementById('blood-pressure').addEventListener('input', function(e) {
        if (!/^\d{0,3}\/?\d{0,3}$/.test(e.target.value)) {
            e.target.setCustomValidity('请输入正确的血压格式，如120/80');
        } else {
            e.target.setCustomValidity('');
        }
    });

    // 睡眠质量选择时更改图标颜色
    document.getElementById('sleep-quality').addEventListener('change', function() {
        const sleepIcon = document.querySelector('.sleep-animation i');
        switch(this.value) {
            case '好':
                sleepIcon.className = 'mdi mdi-sleep text-success';
                break;
            case '一般':
                sleepIcon.className = 'mdi mdi-sleep text-warning';
                break;
            case '差':
                sleepIcon.className = 'mdi mdi-sleep-off text-danger';
                break;
            default:
                sleepIcon.className = 'mdi mdi-weather-night text-primary';
        }
    });

    // 动态身高体重关联效果
    document.getElementById('height').addEventListener('input', function() {
        calculateBMI();
    });
    document.getElementById('weight').addEventListener('input', function() {
        calculateBMI();
    });

    function calculateBMI() {
        const height = document.getElementById('height').value;
        const weight = document.getElementById('weight').value;

        if(height && weight) {
            const heightInMeters = height / 100;
            const bmi = (weight / (heightInMeters * heightInMeters)).toFixed(1);
            // 可以用于未来功能扩展，如实时显示BMI
        }
    }
});

</script>
{% endblock %}
